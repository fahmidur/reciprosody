<%= form_for(@corpus, :multipart => true, :remote => true, :html => {'data-type' => 'json'}) do |f| %>


	<div class='row-fluid'>

		<div id="error_box" class='alert alert-error span11'>
			
			<div id='errors'>
				
			</div>
			
		</div>
		
	</div>

	
	<div class='row-fluid'>

		<div class="field span4">
			<%= f.label :name %>
			<%= f.text_field :name, :title => 'Reminder', 'data-content' => "Please choose an appropriate name. This field is required.<hr/>For more help see our <a href='/how-to' target='_blank'>How-To</a>"%>
		</div>

		<div class="field span4">
			<%= f.label :language, "Language" %>
			<%= f.autocomplete_field :language, '/corpora/autocomplete_language_name', :title => 'Reminder', 'data-content' => "This field is required.<hr/>For more help see our <a href='/how-to' target='_blank'>How-To</a>"%>
		</div>

		<div class='field span4'>
			<%= f.label :num_speakers, "Number of Speakers" %>
			<%= f.number_field :num_speakers, :value => '1' %>
		</div>

	</div>
  
	<div class='row-fluid'>
		<div class='field span4'>
			<%= f.label :hours, "Hours"%>
			<%= f.number_field :hours, :value => 0, :title => 'Reminder', 'data-content' => "The total time must be greater than zero. <hr/>For more help see our <a href='/how-to' target='_blank'>How-To</a>"%>
		</div>

		<div class='field span4'>
			<%= f.label :minutes, "Minutes"%>
			<%= f.number_field :minutes, :value => 0,  :title => 'Reminder', 'data-content' => "The total time must be greater than zero. <hr/>For more help see our <a href='/how-to' target='_blank'>How-To</a>"%>
		</div>

		<div class='field span4'>
			<%= f.label :seconds, "Seconds"%>
			<%= f.number_field :seconds, :value => 0 %>
		</div>

	</div>
  
	<div class='row-fluid'>
		<div class='field span4'>
			<%= f.label :speaker_desc, "Speaker Description" %>
			<%= f.text_field :speaker_desc, :placeholder => 'Male, Late 50s'%>
		</div>
		<div class='field span4'>
			<%= f.label :genre, "Genre" %>
			<%= f.text_field :genre, :placeholder => 'Historical' %>
		</div>

		<div class='field span4'>
			<%= f.label :annotation, "Annotation" %>
			<%= f.text_field :annotation %>
		</div>
	</div>
  
	<div class='row-fluid'>

		<div class='field span4'>
			<%= f.label :license, "License" %>
			<%= f.autocomplete_field :license, '/corpora/autocomplete_license_name' %>
		</div>

		<div class="field span4">
			<%= f.label :upload %>
			<%= f.file_field :upload, :title => 'Reminder', 'data-content' => "Must be a valid .zip, .tgz, or tar.gz<br/>For more help see our <a href='/how-to' target='_blank'>How-To</a>" %>
		</div>

		<div class="field span4">
			<label>New External Members?</label>
			<a href='/user/invite' class='btn' target="_blank">Invite a Friend</a>
		</div>
	
	</div>
  
	<div class='row-fluid'>
	
		<div class="field span4">
			<%= f.label :description %>
			<%= f.text_area :description , :class => 'big_desc', :title => 'Reminder', 'data-content' => "This field supports <a href='http://en.wikipedia.org/wiki/Markdown' target='_blank'>Markdown</a>"%>
		</div>

		<div class="field span4">
			<%= f.label :citation %>
			<%= f.text_area :citation , :class => 'big_desc', :title => 'Reminder', 'data-content' => "This field also supports <a href='http://en.wikipedia.org/wiki/Markdown' target='_blank'>Markdown</a>"%>
		</div>

		<div class="field span4">
			<label for='owners'>Primary Owner</label>

			<div class="input-prepend">
				<span class="add-on"><i class="icon-user"></i></span>
				<%= f.autocomplete_field :owner, '/corpora/autocomplete_user_name', :value => current_user.email_format, :class => 'memberInput', :id => 'primaryOwner' %> 
			</div>
			<br/>
			<div id='help_sticker' class='alert alert-info'>
				<%= render :partial => 'shared/remove_alert_button' %>
				
				<h4>Need Any Help?</h4><br/>
				<p>Visit our <a href='/how-to' target='_blank' class='btn btn-mini'>How-To &nbsp;<i class='icon-circle-arrow-right' style="margin-top:3px;"></i></a></p>
			</div>
		</div>
		
	</div>
	
	
	
	<div class='row-fluid'>
		<div class="actions">
			<!--<%= f.submit :class => 'btn' %>-->
			<input type='submit' value="Create Corpus" class="btn btn-primary span12" onclick="return sendForm(this.form)"/>
		</div>
	</div>

  
<% end %>

<div class="progress progress-striped active">
	<div class="bar" style="width: 0%;" id="pbar"></div>
</div>

<script type='text/javascript'>
	
	var popOversEnabled = false;
	var current_inputId = 0;
	var inputIds = [];
	$(function() {
		dw();
		
		$('#corpus_name').live('keyup', function(e) {
			var val = $(this).val();
			if(val == "" || val.match(/^\s+$/))
				val = "New Corpus";
			$('#corpus_header').html(val);
			
			
		});
		
		$(window).resize(dw);
		
		$('.progress').slideUp(0);
		$('#error_box').hide();
		
		$('input, textarea').focus(function() {
			current_inputId = inputIds.indexOf($(this).attr('id'));
		});
		
		$('input, textarea').each(function() { 
			if($(this).attr('type') != "hidden") {
				inputIds.push($(this).attr('id'));
			}
		});
		
		$(window).bind('keydown', function(e) {
			if(e.keyCode == 9) {
				setTimeout('$("#'+inputIds[++current_inputId % inputIds.length]+'").focus()', 300);
			}
		});
		
		
	});
	
	function sendForm(form) {
		$('.progress').slideDown();
		
		var formData = new FormData(form);
		
		formData.append('data-type', 'json');
		
		var xhr = new XMLHttpRequest();
		
		xhr.open('POST', form.action, true);
		
		xhr.onload = function(e) {
			var data = JSON.parse(this.response);
			if(data.ok) {
				window.location.href = "/corpora/" + data.id;
			} else {
				$('#error_box').show();
				$('#errors').html(data.errors.join("<br>"));
				$('html, body').animate({ scrollTop: 0 }, 'fast');
			}
		};
		
		
		var progressBar = $("#pbar");
		
		xhr.upload.onprogress = function(e) {
			if(e.lengthComputable) {
				var percent = (e.loaded/e.total)*100;
				progressBar.width(percent + '%');
				progressBar.attr('title', percent + " %");
				
				if(percent == 100) {
					$('.progress').delay(1000).slideUp();
				}
			}
		};
		
		xhr.send(formData);
		
		
		return false;
	}
	
	function dw() {
		$('#help_sticker').width($('#primaryOwner').width()-10);
		if(isMobile() && popOversEnabled) {

			$('input, textarea').popover('destroy');
			popOversEnabled = false;
			return;
		}
		if(!isMobile() && !popOversEnabled) {

			$('input, textarea').popover({trigger:'focus', placement: 'right', html: true});
			popOversEnabled = true;
			return;
		}
	}
	function isMobile() {
		if($('div.btn.btn-navbar').is(":visible") && $(window).width() < 520) {
			return true;
		}
		return false;
	}
</script>
