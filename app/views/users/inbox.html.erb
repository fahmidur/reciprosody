<h2>Messages <%= @view.to_s.capitalize %></h2>

<div class='row-fluid'>
	<div class='span3'>
		<a class='btn span12' id='compose_bt' href='#compose'>
			<i class='icon-pencil'></i>&nbsp; Compose
		</a>
		<br/><br/>
		<ul class="nav nav-tabs nav-stacked" id='lmenu'>

			<!--
			<li class='l-nav' id='received_tab'><a href='/user/inbox?v=received' class=''>Inbox 
				<span class='badge pull-right count' id='received-size'><%= @received.size %></span>
			</a></li>
			-->

			<li class='l-nav' id='unread_tab'><a href='/user/inbox?v=unread' class=''>Unread 
				<span class='badge pull-right count' id='unreaded-size'><%= @received.unreaded.size %></span>
			</a></li>

			<li class='l-nav' id='read_tab'><a href='/user/inbox?v=read' class=''>Read
				<span class='badge pull-right count' id='readed-size'><%= @received.readed.size %></span>
			</a></li>

			<li class='l-nav' id='sent_tab'><a href='/user/inbox?v=sent' class=''>Sent 
				<span class='badge pull-right count' id='sent-size'><%= @sent.size %></span>
			</a></li>

			<li class='l-nav' id='trash_tab'><a href='/user/inbox?v=trash' class=''>Trash
				<span class='badge pull-right count' id='deleted-size'><%= @deleted.size %></span>
			</a></li>
		</ul>
	</div>

	<div class='span9'>

		<div class='row-fluid' id='compose_panel' style="display:none;border:1px solid #bbb;margin-bottom:10px;padding:5px; padding-top:8px;box-shadow:0 0 5px #888; background-color:#fff">
				
				
				<a class='pull-right' id='compose_close_bt' href='#' style="margin-top:-8px;text-decoration:none">
					<i class='icon-remove'></i>
				</a>

				<div id='to-wrapper'>
				<span id='to-label' style='display: inline-block;position:relative;top:-2px; color:#8f8f8f;border-bottom:0px solid #efefef;font-size:14px;margin:0px;text-align:right; padding-left:5px;'>To &nbsp; </span><span id='message-recipients' style='position: relative; top:-2px; margin: 0px; border-bottom:0px solid #efefef'></span><input type='text' style='border-radius:0px; height:1em; outline:none; border:0px solid black; box-shadow: inset 0px 0px 0px;width:80%;border-bottom:0px solid #efefef' id='user-search'/>
				</div>
				<hr style="margin:0px;padding:0px;margin-bottom:10px;"/>

				<input type='text' style='border-radius:0px; height:1em; outline:none; border:0px solid black; box-shadow: inset 0px 0px 0px;width:84%;border-bottom:0px solid #efefef;' placeholder="Subject" id='compose-subject'/>

				<hr style="margin:0px;padding:0px;"/>

				<textarea style='border:0px solid black; border-radius:0px;resize:none;width:98%;height:10em;box-shadow: inset 0px 0px 0px;' id='compose-body'></textarea>

				<hr style='margin-bottom:4px;'/>
				<a href='#' class='btn btn-small btn-primary' style="opacity:0.9" id='send_bt'>Send</a>
				
		</div>

		<div class='ib-component'>

		<div class='row-fluid' style="margin-bottom:5px;">
			<% unless @message %>
				<div class='btn btn-mini' id='messagesToggle_bt'>Toggle</div>
			<% end %>

			<div class='btn-group'>
				<% if @view == :trash %>
					<button class='btn btn-mini' id='restore_bt'>Restore</button>
					<button class='btn btn-mini btn-danger' id='delete_bt'>Delete</button>
				<% else %>
					<% if @view != :sent %>
						<% if @view != :read %>
						<button class='btn btn-mini <%= "btn-primary" if @message %>'>Mark as Read</button>
						<% end %>
						<% if @view != :unread %>
						<button class='btn btn-mini'>Mark as Unread</button>
						<% end %>
					<% end %>
					<button class='btn btn-mini btn-danger' id='delete_bt'>Delete</button>
				<% end %>
			</div>
			<span class='badge badge-info'><span id='numMessagesSelected'>0</span> Selected</span>
		</div>

		<% if @message && !@message.is_a?(Array)%>
			<!--
			<div class='row-fluid' id='current-message' data-id='<%= @message.id %>'>

				<h6>
					<span class=''><%= @message.created_at %></span>
					<span class='badge pull-right'>
						<%= time_ago_in_words(@message.created_at)%> ago
					</span>
				</h6>

				<table>
					<tr>
						<td>
							<span class='label'>From: </span>
						</td>

						<td>
							<%= render :partial => 'shared/user_small1', :locals => { :user => @message.from} %></td>
						</td>

					</tr>
					<td>
						<span class='label'>To:</span>
					</td>
					<td>
						<%= render :partial => 'shared/user_small1', :locals => { :user => @message.to } %> </h6>
					</td>
					<tr>
						<td colspan='2'>
							<span class='label'>Subject:</span> &nbsp;
							<span><%= @message.topic %></span>
						</td>
					</tr>
				</table>
				<br/>
			</div>
			<div class='row-fluid'>
				<div class='span12' style="padding:1em; border-left:2px solid orange;background-color:#fafafa">
					<%= @message.body %>
				</div>
			</div>
			-->
			<div id='cmessage' data-id='<%= @message.id %>' style='border:1px solid #bbb;margin-bottom:10px;padding:5px; padding-top:8px;box-shadow:0 0 5px #888; background-color:#fff'>
				<!--<%= render :partial => 'shared/user_small1', :locals => {:user => @message.from } %>-->
				<div class='btn-group'>
					<a href='/users/<%= @message.from.email %>' class="btn btn-mini" target='_blank'>
						<i class='icon-user'></i>&nbsp;<%= @message.from.name %>
					</a>
					<button class="btn btn-mini disabled"><%= @message.from.email %></button>
				</div>

				<% if @view == :sent %>
					<i class='icon-arrow-right'></i>
					<div class='btn-group'>
						<a href='/users/<%= @message.from.email %>' class="btn btn-mini" target='_blank'>
							<i class='icon-user'></i>&nbsp;<%= @message.to.name %>
						</a>
						<button class="btn btn-mini disabled"><%= @message.to.email %></button>
					</div>
				<% end %>

				<a class='pull-right' id='cmessage_close_bt' href='#' style="margin-top:-8px;text-decoration:none">
					<i class='icon-remove'></i>
				</a>

				<hr style="margin:0px;padding:0px;margin-bottom:10px;margin-top:10px;"/>
				<div style='border-radius:0px; height:1em; outline:none; border:0px solid black; box-shadow: inset 0px 0px 0px;width:84%;border-bottom:0px solid #efefef;padding:3px;padding-bottom:15px;' placeholder="Subject" id='cmessage-subject'><%= @message.topic %></div>

				<hr style="margin:0px;padding:0px;"/>

				<div style='border:0px solid black; border-radius:0px;resize:none;width:98%;height:10em;box-shadow: inset 0px 0px 0px;padding:3px;' id='cmessage-body'><%= @message.body %></div>

				<hr style='margin-bottom:4px;'/>
				<small style='font-weight:bold;color:#8d8d8d'><%= @message.created_at %></small>
				<small class='pull-right' style='font-weight:bold;color:#8d8d8d'><%= time_ago_in_words(@message.created_at) %> ago</small>

			</div>
		<% else %>
			<table width="100%" class='inbox_table' id='message-table'>
			<% @select_messages.process do |m| %>
				<%= render :partial => 'inbox_message', :locals => {:m => m, :view => @view} %>
			<% end %>
			</table>
		<% end %>
	</div> <!---end of .ib-component-->
	</div> <!---end of .span9-->
</div>

<div class="modal hide fade" id="delete-confirm" style="display:none">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">Ã—</a>
		<h3>Are you sure?</h3>
	</div>
	<div class="modal-body">
		<p id='delete-message'>You are about to delete <span class='badge badge-warning' id='delete-count'></span> message item<span id='delete-plural'>s</span>.</p>
	</div>
	<div class="modal-footer">
		<button class='btn btn-danger' id='yes-delete'>Yes, Delete</button>
		<a href="#" data-dismiss="modal" class="btn">Cancel</a>
	</div>
</div>

<div id='user-search-result' style="position:absolute; display:none; background-color:#fefefe; border:1px solid #efefef;padding-top:10px;">
</div>

<script type='text/javascript'>
	var _view = "";
	var _overMessageSelect = false;
	var _selectedMessages = null;
	var _selectedUsers = new Array();
	var _maxMemberSize = 0;
	var _people_result = null;
	var _userSearchEmpty = false;

	var _counts = new Array();
	$('.count').each(function(i) {
		_counts.push(parseInt($(this).html()));
	});
	/*console.log(_counts);*/

	//----MAIN-----



	<% if @message && !@message.is_a?(Array) %>
		_selectedMessages = [$('#cmessage').attr('data-id')];
		console.log(_selectedMessages);
		$('#numMessagesSelected').html(_selectedMessages.length);
	<% else %>
		updateSelected();
	<% end %>

	adjustMemberLinks();
	//----------------------------------------------------------------------

	//----EVENTS------------------------------------------------------------
	$('#compose-subject').live('focus', function() {
		/*console.log("compose subject focus");*/
		$('#user-search-result').hide();
	});
	$('.user-result').live('mouseenter', function() {
		$(".user-result").removeClass("user-selected");
		$(this).addClass('user-selected');
	});
	$('.user-result').live('click', function() {
		addSelectedUser();
	});
	function removeUser(user) {
		var id = user.attr('data-id');
		user.remove();
		delete _selectedUsers[id];

		/*console.log("Selected Users:");*/
		/*console.log(_selectedUsers);*/
	}
	function fixSearchWidth() {
		/*console.log("fixing search width");*/
		var currentWidth = $('#user-search').width();
		var newWidth = $('#compose_panel').width() - $('#to-label').width() - $('#message-recipients').width() - 200;

		if(newWidth < currentWidth && newWidth > 200) {
			$('#user-search').width(newWidth);
		} else if(newWidth > currentWidth) {
			$('#user-search').width(newWidth);
		}
	}
	$('#compose-subject').focus(function() {
		$('#user-search').hide();
	});
	$('#to-wrapper').click(function() {
		$('#user-search').show();
		$('#user-search').focus();
	});
	$('#user-search').live('keydown', function(e) {
		if(e.keyCode == 9) {
			//console.log("Tab event!");
			addSelectedUser();
			return;
		}
	});
	$('#user-search').live('keyup', function(e) {
		if(e.keyCode == 13) {
			/*console.log("Enter event!");*/
			addSelectedUser();
			return;
		}
		if(e.keyCode == 38 && $('.user-selected').prev().is('.user-result')) {
			var target = $('.user-selected').prev();
			$('.user-result').removeClass('user-selected');
			target.addClass('user-selected');
			return;
		} 
		if(e.keyCode == 40 && $('.user-selected').next().is('.user-result')) {
			var target = $('.user-selected').next();
			$('.user-result').removeClass('user-selected');
			target.addClass('user-selected');
			return;
		}
		if(e.keyCode == 27) {
			$('#user-search-result').hide();
			$('#user-search').val("");
			return;
		}
		var v = $(this).val();
		if(e.keyCode == 8 && _userSearchEmpty && v.length == 0) {
			removeUser($('.user-label:last'));
			_userSearchEmpty = false; //give them a chance
			return;
		}
		if(v.length == 0 || v.match(/^\s+$/)) {
			$('#user-search-result').hide();
			$('#user-search').val("");
			_userSearchEmpty = true;
			return;
		} else {
			_userSearchEmpty = false;
		}
		
		$.getJSON("/users/mixed_search", {q:v}, function(data) {
			if(document.activeElement !== document.getElementById('user-search')) {
				return;
			}
			_people_result = data;
			if(data.length <= 0) {return;}
			// /*console.log(_people_result);*/
			var html = "";
			for(var i in _people_result) {
				html += "<div class='user-result' data-id='"+_people_result[i].id+"' data-index='"+i+"'><div class='name'>"+_people_result[i].name+"</div><div class='email'>"+_people_result[i].email+"</div></div>";
			}
			$('#user-search-result').html(html);

			var o = $('#to-label').offset();
			var io = $('#user-search').offset();

			$('#user-search-result').css('top',io.top+22);
			$('#user-search-result').css('left',o.left);
			$('#user-search-result').css('width',$('#user-search').width() + $('#message-recipients').width());
			$('#user-search-result').css('height',(32+10)*_people_result.length + 10);
			$('#user-search-result').delay(200).show(0);


			$('.user-result:first').addClass('user-selected');

			setTimeout(fixSearchWidth, 400);
		});
	});

	$('#compose_bt').live('click',function() {
		/*console.log("Compose BT");*/
		stateRestore_compose();
	});
	$('#compose_close_bt').live('click', function() {
		/*console.log("Compose Close BT");*/
		stateRestore_normal();
	});
	$('#cmessage_close_bt').click(function() {
		$('#cmessage').slideUp(300);
		setTimeout(goToBase, 400);
	});

	$('.messageSelect').on('mouseenter', function() {
		///*console.log("over message select");*/
		_overMessageSelect = true;
	});
	$('.messageSelect').on('mouseleave', function() {
		///*console.log("left message select");*/
		_overMessageSelect = false;
	});
	$('#messagesToggle_bt').click(function() {
		_overMessageSelect = true;
		$('.messageSelect').each(function() {
			$(this).click();
		});
		_overMessageSelect = false;
	});
	$('.messageSelect').on('change', updateSelected);
	$('#delete_bt').click(function() {
		/*console.log("DELETE!");*/
		if(_selectedMessages.length > 0) {
			$('#delete-confirm').modal('show');
			if(_selectedMessages.length == 1) {
				$('#delete-plural').html("");
			} else {
				$('#delete-plural').html("");
			}
			$('#delete-count').html(_selectedMessages.length);
		}
	});
	$('.user-label').live('mouseenter', function() {
		var id = $(this).attr('data-id');
		$('#user-search-result').html("<div class='user-result' data-id='"+id+"''><div class='name'>"+_selectedUsers[id].name+"</div><div class='email'>"+_selectedUsers[id].email+"</div></div>");
		$('#user-search-result').height(48);
		$('#user-search-result').show();
	});
	$('.user-label').live('mouseleave', function() {
		$('#user-search-result').hide();
	});
	$('.user-label').live('click', function() {
		var id = $(this).attr('data-id');
		$(this).remove();
		delete _selectedUsers[id];
		fixSearchWidth();
		$('#user-search-result').hide();
	});
	$('#yes-delete').click(function() {
		/*console.log("YES DELETE");*/
		console.log(_selectedMessages);
		var mids = _selectedMessages.join("\n");

		$.getJSON('/user/inbox_delete', {'mids': mids}, function(data) {
			console.log(data);
			if(data.ok) {
				var current = $('#current-size');
				var deleted = $('#deleted-size');
				if(deleted.length == 0) {
					deleted = $('#current-size');
				}


				<% if @message && !@message.is_a?(Array) %>
					console.log("No reason to update");
				<% else %>
					var v = parseInt(current.html());
					current.html((v -= data.moved_to_trash));
					current.html(v - data.gone);

					v = parseInt(deleted.html());
					deleted.html(v+data.moved_to_trash);

					v = parseInt(deleted.html());
					deleted.html(v-data.permanently_deleted);
				<% end %>

				
			}
		});
		

		<% if @message && !@message.is_a?(Array) %>
			$('#cmessage').slideUp(200);
			setTimeout(goToBase, 300);
		<% else %>
			updateSelected();
			for(i in _selectedMessages) {
				$('#message-row-'+_selectedMessages[i]).remove();
			}
		<% end %>

		/*console.log(_selectedMessages.size);*/


		$('#deleted-size').html(_selectedMessages.size);

		$('#delete-confirm').modal('hide');
	});
	window.onpopstate = restoreState;
	$('#send_bt').click(function() {
		var ids = new Array();
		$('.user-label').each(function(i) {
			// console.log($(this).attr('data-id'));
			ids.push($(this).attr('data-id'));
		});
		console.log(ids);
		var subject = $('#compose-subject').val();
		var body = $('#compose-body').val();

		console.log("Subject: " + subject);
		console.log("Body: " + body);

		//--do validation
		var blank = /^\s*$/;
		if(ids.length == 0 || subject.match(blank) || body.match(blank)) {
			console.log("Message not sent");
			setTimeout(stateRestore_compose, 500);
			return;
		}

		console.log("Sending Message...");
		$.getJSON('/user/send_message', {'to': ids, 'subject': subject, 'body': body}, function(data) {
			console.log(data);
			stateRestore_normal();
			var target = $('#sent-size');
			if(target.length == 0) {
				target = $('#current-size');
			}
			target.html(parseInt(target.html())+ids.length);
		});

	});
	//------FUNCTIONS---------------------------------------------
	function goToBase() {
		url = window.location.href;
		url = url.replace(/\&mid=\d+\#*.*$/, '')
		window.location.href = url;
	}
	function addSelectedUser() {
		$('#user-search-result').hide();
		$('#user-search').val("");

		var user = $('.user-selected');
		if(user.length == 0) {
			return;
		}

		var name = user.find('.name').text();
		var email = user.find('.email').text();
		var id = user.attr('data-id');

		if(id == $('#hf-userID').val()) {
			return;
		}

		/*console.log(name + "\t" + email + "\t" + id);*/

		if(_selectedUsers[id]) { return; }
		
		_selectedUsers[id] = {
			'name': name,
			'email': email,
			'id': id
		};

		/*console.log(_selectedUsers);*/

		$('#message-recipients').append('<span class="label user-label" data-id="'+id+'"><i class="icon-user"></i>&nbsp; '+name+'&nbsp;<i class="icon-remove"></i></span>');

		// $('#to-label').height($('#message-recipients').height());
	}
	function restoreState() {
		/*console.log("restoring state");*/
		var capture = /v=(\w+)/.exec(document.URL);
		if(capture) {
			_view = capture[1];
		}
		var target = $('#'+_view + "_tab");
		if(target.length) {
			target.addClass('active');
		} else {
			$('#unread_tab').addClass('active');
		}
		$('#lmenu').find(".active a .count").css('background-color', 'black');
		$('#lmenu').find(".active a .count").attr('id', 'current-size');

		//now restore composition state
		capture = /\#(\w+)/.exec(document.URL);
		if(capture) {
			eval("stateRestore_"+capture[1]+"()");
		} else {
			stateRestore_normal();
		}

	}
	function stateRestore_compose() {
		/*console.log("Restoring compose state");*/
		$('.ib-component').slideUp();
		$('#compose_panel').slideDown();
		$('#user-search').focus();
		history.replaceState({state: 'compose'}, "Title", "#compose");
	}
	function stateRestore_normal() {
		/*console.log("Restoring normal state");*/
		$('#user-search-result').hide();
		$('#compose_panel').slideUp();
		$('.ib-component').slideDown();
		history.replaceState({state: 'normal'}, "Title", "#");
	}
	function messageOpen(str) {
		if(_overMessageSelect) {
			return;
		}
		window.location = str;
	}
	function updateSelected() {
		_selectedMessages = new Array();
		$('.messageSelect').each(function(item) {
			var row = $(this).parent().parent();
			if($(this).attr('checked') === 'checked') {
				row.addClass('selected');
				_selectedMessages.push(row.attr('data-id'));
			} else {
				row.removeClass('selected');
			}
		});
		/*console.log(_selectedMessages);*/
		$('#numMessagesSelected').html(_selectedMessages.length);
	}
	function adjustMemberLinks() {
		$(".member-link").each(function() {
			var w = $(this).html().length;
			if(w > _maxMemberSize) {
				_maxMemberSize = w;
			}
		});
		$(".member-link").each(function() {
			var h = $(this).html();
			var w = h.length;
			if(w < _maxMemberSize) {
				$(this).html(h + Array(_maxMemberSize-w+1).join("&nbsp; "));
			}
		});
	}
</script>